<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Algorithm Code Snippet</title>
    <style>
        body {
            background-color: #1e1e1e; /* VS Code Dark Background */
            color: #d4d4d4; /* Default Text Color */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .window {
            background-color: #1e1e1e;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-radius: 6px;
            overflow: hidden;
            width: 900px;
            max-width: 95vw;
        }

        .title-bar {
            background-color: #252526;
            padding: 8px 15px;
            font-size: 13px;
            color: #9cdcfe;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
        }

        .title-bar .dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .dot.red { background-color: #ff5f56; }
        .dot.yellow { background-color: #ffbd2e; }
        .dot.green { background-color: #27c93f; }

        .editor-container {
            padding: 10px 0;
            overflow-x: auto;
        }

        pre {
            margin: 0;
            line-height: 1.5;
        }

        code {
            display: block;
            padding: 0 15px;
        }

        /* Syntax Highlighting (approximate VS Code Dark+) */
        .keyword { color: #c586c0; } /* import, export, class, async, return, if, const */
        .function { color: #dcdcaa; } /* getEvaluation, filter, map */
        .type { color: #4ec9b0; } /* Promise, TargetParams */
        .string { color: #ce9178; }
        .number { color: #b5cea8; }
        .comment { color: #6a9955; }
        .variable { color: #9cdcfe; }
        .property { color: #9cdcfe; }
        .operator { color: #d4d4d4; }
        
        .line-num {
            color: #858585;
            display: inline-block;
            width: 30px;
            text-align: right;
            margin-right: 15px;
            user-select: none;
        }
    </style>
</head>
<body>

<div class="window">
    <div class="title-bar">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
        <span style="margin-left: 10px; color: #ccc;">EvaluasiCPLService.ts</span>
    </div>
    <div class="editor-container">
<pre><code>
<span class="line-num">90</span>    <span class="keyword">static async</span> <span class="function">getEvaluation</span>(<span class="variable">params</span>: <span class="type">TargetParams</span>) {
<span class="line-num">91</span>        <span class="keyword">const</span> { <span class="variable">prodiId</span>, <span class="variable">angkatan</span>, <span class="variable">tahunAjaran</span>, <span class="variable">semester</span> } = <span class="variable">params</span>;
<span class="line-num">92</span>
<span class="line-num">93</span>        <span class="keyword">try</span> {
<span class="line-num">94</span>            <span class="comment">// 1. Get Targets</span>
<span class="line-num">95</span>            <span class="keyword">const</span> <span class="variable">targets</span> = <span class="keyword">await</span> <span class="variable">this</span>.<span class="function">getTargets</span>(<span class="variable">params</span>);
<span class="line-num">96</span>            <span class="keyword">const</span> <span class="variable">targetMap</span> = <span class="keyword">new</span> <span class="type">Map</span>(<span class="variable">targets</span>.<span class="function">map</span>(<span class="variable">t</span> => [<span class="variable">t</span>.<span class="property">cplId</span>, <span class="variable">t</span>.<span class="property">target</span>]));
<span class="line-num">97</span>
<span class="line-num">98</span>            <span class="comment">// 2. Get Actual Scores (Average of students in this cohort)</span>
<span class="line-num">99</span>            <span class="keyword">const</span> <span class="variable">students</span> = <span class="keyword">await</span> <span class="variable">prisma</span>.<span class="property">profile</span>.<span class="function">findMany</span>({
<span class="line-num">100</span>               <span class="property">where</span>: {
<span class="line-num">101</span>                   <span class="property">prodiId</span>,
<span class="line-num">102</span>                   <span class="property">angkatanRef</span>: { <span class="property">tahun</span>: <span class="function">parseInt</span>(<span class="variable">angkatan</span>) }
<span class="line-num">103</span>               },
<span class="line-num">104</span>               <span class="property">select</span>: { <span class="property">userId</span>: <span class="keyword">true</span> }
<span class="line-num">105</span>           });
<span class="line-num">106</span>
<span class="line-num">107</span>           <span class="keyword">const</span> <span class="variable">studentIds</span> = <span class="variable">students</span>.<span class="function">map</span>(<span class="variable">s</span> => <span class="variable">s</span>.<span class="property">userId</span>);
<span class="line-num">108</span>
<span class="line-num">118</span>           <span class="comment">// Calculate average CPL for this cohort</span>
<span class="line-num">123</span>           <span class="keyword">const</span> <span class="variable">whereNilai</span>: <span class="type">any</span> = { <span class="property">mahasiswaId</span>: { <span class="property">in</span>: <span class="variable">studentIds</span> } };
<span class="line-num">126</span>           <span class="keyword">if</span> (<span class="variable">tahunAjaran</span>) <span class="variable">whereNilai</span>.<span class="property">tahunAjaranId</span> = <span class="variable">tahunAjaran</span>;
<span class="line-num">127</span>
<span class="line-num">132</span>           <span class="keyword">const</span> <span class="variable">allScores</span> = <span class="keyword">await</span> <span class="variable">prisma</span>.<span class="property">nilaiCpl</span>.<span class="function">findMany</span>({
<span class="line-num">133</span>               <span class="property">where</span>: <span class="variable">whereNilai</span>,
<span class="line-num">134</span>               <span class="property">include</span>: { <span class="property">mataKuliah</span>: <span class="keyword">true</span> }
<span class="line-num">135</span>           });
<span class="line-num">136</span>
<span class="line-num">139</span>           <span class="keyword">const</span> <span class="variable">allCpls</span> = <span class="keyword">await</span> <span class="variable">prisma</span>.<span class="property">cpl</span>.<span class="function">findMany</span>({ <span class="property">where</span>: { <span class="property">prodiId</span>, <span class="property">isActive</span>: <span class="keyword">true</span> } });
<span class="line-num">149</span>
<span class="line-num">150</span>           <span class="keyword">const</span> <span class="variable">evaluation</span> = <span class="variable">allCpls</span>.<span class="function">map</span>(<span class="variable">cpl</span> => {
<span class="line-num">151</span>               <span class="keyword">const</span> <span class="variable">cplScores</span> = <span class="variable">allScores</span>.<span class="function">filter</span>(<span class="variable">s</span> => <span class="variable">s</span>.<span class="property">cplId</span> === <span class="variable">cpl</span>.<span class="property">id</span>);
<span class="line-num">152</span>               <span class="keyword">const</span> <span class="variable">target</span> = <span class="variable">targetMap</span>.<span class="function">get</span>(<span class="variable">cpl</span>.<span class="property">id</span>) ?? <span class="number">75.0</span>;
<span class="line-num">153</span>
<span class="line-num">154</span>               <span class="comment">// 1. Calculate Actual Score (Avg of student averages)</span>
<span class="line-num">159</span>               <span class="keyword">const</span> <span class="variable">studentScoresMap</span> = <span class="keyword">new</span> <span class="type">Map</span><<span class="type">string</span>, <span class="type">number</span>[]>();
<span class="line-num">160</span>               <span class="variable">cplScores</span>.<span class="function">forEach</span>(<span class="variable">s</span> => {
<span class="line-num">161</span>                   <span class="keyword">if</span> (!<span class="variable">studentScoresMap</span>.<span class="function">has</span>(<span class="variable">s</span>.<span class="property">mahasiswaId</span>)) <span class="variable">studentScoresMap</span>.<span class="function">set</span>(<span class="variable">s</span>.<span class="property">mahasiswaId</span>, []);
<span class="line-num">162</span>                   <span class="variable">studentScoresMap</span>.<span class="function">get</span>(<span class="variable">s</span>.<span class="property">mahasiswaId</span>)?.<span class="function">push</span>(<span class="function">Number</span>(<span class="variable">s</span>.<span class="property">nilai</span>));
<span class="line-num">163</span>               });
<span class="line-num">164</span>
<span class="line-num">169</span>               <span class="variable">studentScoresMap</span>.<span class="function">forEach</span>((<span class="variable">scores</span>) => {
<span class="line-num">170</span>                   <span class="keyword">const</span> <span class="variable">studentAvg</span> = <span class="variable">scores</span>.<span class="function">reduce</span>((<span class="variable">a</span>, <span class="variable">b</span>) => <span class="variable">a</span> + <span class="variable">b</span>, <span class="number">0</span>) / <span class="variable">scores</span>.<span class="property">length</span>;
<span class="line-num">171</span>                   <span class="variable">totalStudentAvg</span> += <span class="variable">studentAvg</span>;
<span class="line-num">172</span>                   <span class="keyword">if</span> (<span class="variable">studentAvg</span> >= <span class="variable">target</span>) <span class="variable">passCount</span>++;
<span class="line-num">173</span>                   <span class="variable">studentCountForCpl</span>++;
<span class="line-num">174</span>               });
<span class="line-num">175</span>
<span class="line-num">176</span>               <span class="keyword">const</span> <span class="variable">actual</span> = <span class="variable">studentCountForCpl</span> > <span class="number">0</span> ? <span class="variable">totalStudentAvg</span> / <span class="variable">studentCountForCpl</span> : <span class="number">0</span>;
<span class="line-num">177</span>               <span class="comment">// ... Return results</span>
<span class="line-num">203</span>               <span class="keyword">return</span> { <span class="property">cplId</span>: <span class="variable">cpl</span>.<span class="property">id</span>, <span class="property">actual</span>: <span class="function">Number</span>(<span class="variable">actual</span>.<span class="function">toFixed</span>(<span class="number">2</span>)), <span class="property">status</span> };
<span class="line-num">214</span>           });
<span class="line-num">216</span>           <span class="keyword">return</span> { <span class="property">evaluation</span>, <span class="property">summary</span> };
<span class="line-num">226</span>       } <span class="keyword">catch</span> (<span class="variable">error</span>) {
<span class="line-num">227</span>           <span class="variable">console</span>.<span class="function">error</span>(<span class="string">'Error in EvaluasiCPLService'</span>, <span class="variable">error</span>);
<span class="line-num">228</span>           <span class="keyword">throw</span> <span class="variable">error</span>;
<span class="line-num">233</span>       }
<span class="line-num">234</span>    }
</code></pre>
    </div>
</div>

</body>
</html>
